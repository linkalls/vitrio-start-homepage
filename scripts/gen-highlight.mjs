import { createHighlighter } from 'shiki'
import { writeFileSync } from 'node:fs'
import { join } from 'node:path'

const SNIPS = [
  {
    key: 'routes_ts',
    lang: 'ts',
    code: `defineRoute({
  path: '/reference',
  loader: (ctx) => ({ /* ... */ }),
  action: (ctx, formData) => ({ /* ... */ }),
  component: ({ data, csrfToken }) => <Page />,
})`,
  },
  {
    key: 'form_html',
    lang: 'html',
    code: `<form method="post">\n  <input type="hidden" name="_csrf" value={csrfToken} />\n  ...\n</form>`,
  },
  {
    key: 'headers_text',
    lang: 'text',
    code: `X-Content-Type-Options: nosniff\nReferrer-Policy: strict-origin-when-cross-origin\nContent-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'`,
  },
  {
    key: 'wrangler_toml',
    lang: 'toml',
    code: `[assets]\ndirectory = "dist/client"\nbinding = "ASSETS"\nrun_worker_first = true`,
  },
  {
    key: 'commands_bash',
    lang: 'bash',
    code: `bun run dev\nbun run build\nbunx wrangler deploy`,
  },
]

const h = await createHighlighter({
  themes: ['github-dark'],
  langs: ['ts', 'tsx', 'html', 'toml', 'bash', 'text'],
})

const out = {}
for (const s of SNIPS) {
  out[s.key] = h.codeToHtml(s.code, { lang: s.lang, theme: 'github-dark' })
}

const file = `// AUTO-GENERATED by scripts/gen-highlight.mjs\n// Do not edit manually.\n\nexport const HIGHLIGHT = ${JSON.stringify(out, null, 2)} as const\n`
writeFileSync(join(process.cwd(), 'src/server/highlight.ts'), file, 'utf8')
console.log('[gen-highlight] wrote src/server/highlight.ts')
